# 数据采集功能说明

## 功能概述

数据采集抽屉式按钮提供了多种数据导入方式，确保数据能够高效、准确地进入SPC分析系统。

## 主要功能

### 1. Excel/CSV 文件导入

**功能特性：**
- 支持 `.xlsx`、`.xls` 和 `.csv` 三种文件格式
- 拖拽或点击上传
- 自动解析文件内容和规格限元数据（USL、LSL、Target）
- 支持多值格式（X-bar R 图）和单值格式（I-MR 图）

**导入模板下载：**
- Excel 模板（多值格式）：适用于 X-bar R 控制图
- Excel 模板（单值格式）：适用于 I-MR 控制图
- CSV 模板（多值格式/单值格式）：纯文本格式，兼容性更好

**数据校验：**
- 自动检查数据完整性
- 检测无效值（NaN、空值等）
- 标识错误行，并提供修正或删除功能
- 支持查看前20行数据预览
- 显示校验结果（错误和警告）

### 2. 手动录入

**功能特性：**
- 逐条录入测量数据
- 支持单个或多个测量值（用逗号分隔）
- 可选填时间戳和组号
- 实时预览已录入的数据
- 支持批量录入后一次性导入

**使用场景：**
- 数据量较小时的快速录入
- 补充现有数据
- 临时测试数据输入

### 3. 数据库直连（预留）

**规划功能：**
- 支持主流数据库（MySQL、PostgreSQL、SQL Server等）
- 配置数据库连接参数
- 选择数据表和字段映射
- 设置数据筛选条件
- 实时数据同步

**当前状态：**
- 接口已预留
- 功能正在开发中

## 使用流程

### Excel/CSV 导入流程

1. 点击页面右上角的"数据采集"按钮
2. 在弹出的抽屉中选择"Excel/CSV 导入"标签
3. （可选）下载对应格式的模板文件
4. 按照模板格式准备数据
5. 拖拽或点击上传数据文件
6. 系统自动校验数据
7. 查看预览和校验结果
8. 如有错误：
   - 选择"修正"按钮修改错误数据
   - 或选择"删除"按钮移除错误行
   - 或点击"删除所有错误行"批量清理
9. 点击"确认导入"完成数据导入

### 手动录入流程

1. 点击页面右上角的"数据采集"按钮
2. 在弹出的抽屉中选择"手动录入"标签
3. 填写表单：
   - 时间戳（选填）
   - 组号（选填）
   - 测量值（必填，多个值用逗号分隔）
4. 点击"添加数据"按钮
5. 重复步骤3-4录入更多数据
6. 查看已录入数据预览
7. 点击"确认导入"完成数据导入

## 文件格式说明

### Excel 多值格式示例

```
规格信息
规格上限 (USL)    11.0
规格下限 (LSL)    9.5
目标值 (Target)   10.25

时间戳              组号    测量值1    测量值2    测量值3    测量值4    测量值5
2024-01-01 08:00    1      10.2      10.3      10.1      10.4      10.2
2024-01-01 09:00    2      10.1      10.2      10.3      10.2      10.1
```

### Excel 单值格式示例

```
规格信息
规格上限 (USL)    11.0
规格下限 (LSL)    9.5
目标值 (Target)   10.25

时间戳              组号    测量值
2024-01-01 08:00    1      10.2
2024-01-01 09:00    2      10.3
2024-01-01 10:00    3      10.1
```

### CSV 格式示例

```csv
规格上限 (USL),11.0
规格下限 (LSL),9.5
目标值 (Target),10.25

时间戳,组号,测量值1,测量值2,测量值3,测量值4,测量值5
2024-01-01 08:00,1,10.2,10.3,10.1,10.4,10.2
2024-01-01 09:00,2,10.1,10.2,10.3,10.2,10.1
```

## 数据校验规则

系统会自动检查以下项目：

1. **数据完整性：**
   - 至少包含3行有效数据
   - 每行必须包含测量值

2. **数据格式：**
   - 测量值必须是有效数字
   - 不允许 NaN、Infinity 等无效值

3. **一致性检查：**
   - 子组大小是否一致
   - 数据列数是否符合预期

4. **异常值检测：**
   - 检测极端异常值（> 6σ）
   - 以警告形式提醒用户

## 错误处理

### 常见错误及解决方法

**错误：不支持的文件格式**
- 解决：确保文件扩展名为 .xlsx、.xls 或 .csv

**错误：缺少测量值**
- 解决：检查每行数据是否包含至少一个有效的测量值

**错误：测量值无效**
- 解决：确保测量值为有效数字，不要包含文本或特殊字符

**错误：子组大小不一致**
- 解决：确保每行的测量值数量相同，或下载并使用标准模板

## 技术实现

### 文件清单

1. **`src/components/DataImportDrawer/index.tsx`**
   - 数据导入抽屉主组件
   - 包含三个标签页：Excel/CSV 导入、手动录入、数据库直连

2. **`src/utils/templateGenerator.ts`**
   - 模板生成工具
   - 提供 Excel 和 CSV 模板下载功能

3. **`src/utils/excelHandler.ts`**
   - Excel/CSV 文件解析工具（已有）
   - 数据校验工具（已有）

### 组件架构

```
DataImportDrawer
├── Excel/CSV 导入标签
│   ├── 模板下载区
│   ├── 文件上传区（拖拽上传）
│   ├── 校验结果显示
│   └── 数据预览表格（支持错误行修正/删除）
├── 手动录入标签
│   ├── 数据录入表单
│   └── 已录入数据预览
└── 数据库直连标签
    └── 功能说明（开发中）
```

## 后续优化建议

1. **数据库直连功能**
   - 实现数据库连接配置
   - 支持 SQL 查询
   - 实现数据同步

2. **批量编辑功能**
   - 支持在预览表格中直接编辑数据
   - 批量替换功能

3. **数据转换**
   - 支持单位转换
   - 数据格式化选项

4. **导入历史**
   - 记录导入历史
   - 支持重新导入之前的文件

5. **更多文件格式**
   - 支持 JSON 格式
   - 支持纯文本格式（TXT）

## 联系与反馈

如有问题或建议，请联系开发团队。
